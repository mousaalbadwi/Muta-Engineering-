@model MutaEngineering.ViewModels.LoginViewModel
@inject Microsoft.Extensions.Configuration.IConfiguration Config

@{
    var isRtl = System.Globalization.CultureInfo.CurrentUICulture.TextInfo.IsRightToLeft;
    ViewData["Title"] = isRtl ? "تسجيل الدخول" : "Sign in";

    bool hasGoogle = !string.IsNullOrWhiteSpace(Config["Authentication:Google:ClientId"])
                    && !string.IsNullOrWhiteSpace(Config["Authentication:Google:ClientSecret"]);
    bool hasGitHub = !string.IsNullOrWhiteSpace(Config["Authentication:GitHub:ClientId"])
                    && !string.IsNullOrWhiteSpace(Config["Authentication:GitHub:ClientSecret"]);
    bool hasFacebook = !string.IsNullOrWhiteSpace(Config["Authentication:Facebook:AppId"])
                    && !string.IsNullOrWhiteSpace(Config["Authentication:Facebook:AppSecret"]);
}

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-12 col-lg-10">
            <div class="auth-shell shadow-sm rounded-4 overflow-hidden">
                <!-- Illustration column -->
                <div class="auth-illustration d-none d-lg-flex align-items-center justify-content-center p-0">
                    <img src="~/img/illustrations/login-amico2.svg"
                         alt="Illustration"
                         class="auth-illustration-img"
                         onerror="this.style.display='none'; document.getElementById('illustFallbackLogin').style.display='block';" />
                    
                </div>

                <!-- Form column -->
                <div class="auth-form p-4 p-md-5">
                    <h3 class="mb-3 text-center">@ViewData["Title"]</h3>
                    <p class="text-muted text-center mb-4">
                        @((isRtl ? "ادخل رقم هاتفك وكلمة المرور أو اختر موفّرًا" : "Enter your phone and password or choose a provider"))
                    </p>

                    <form asp-action="Login" method="post" class="needs-validation" novalidate>
                        <input type="hidden" name="returnUrl" value="@(ViewBag.ReturnUrl ?? "")" />
                        <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

                        <div class="row g-3">
                            <div class="col-12">
                                <label asp-for="PhoneNumber" class="form-label">@((isRtl ? "رقم الهاتف" : "Phone number"))</label>
                                <input asp-for="PhoneNumber" class="form-control form-control-lg" placeholder="07xxxxxxxx" required />
                                <span asp-validation-for="PhoneNumber" class="text-danger small"></span>
                            </div>

                            <div class="col-12">
                                <label asp-for="Password" class="form-label">@((isRtl ? "كلمة المرور" : "Password"))</label>
                                <input asp-for="Password" type="password" class="form-control form-control-lg" required />
                                <span asp-validation-for="Password" class="text-danger small"></span>
                            </div>
                        </div>

                        <button class="btn btn-primary btn-lg w-100 mt-4">
                            @((isRtl ? "تسجيل الدخول" : "Sign in"))
                        </button>
                    </form>

                    <div class="divider my-4"><span>@((isRtl ? "أو" : "or"))</span></div>

                    <!-- Social Providers: تظهر دائمًا؛ تتفعّل إذا المفاتيح موجودة -->
                    <div class="row g-2">
                        <div class="col-12 col-md-4">
                            @if (hasGoogle)
                            {
                                <form asp-action="ExternalLogin" method="post">
                                    <input type="hidden" name="provider" value="Google" />
                                    <button type="submit" class="btn btn-outline-danger w-100 social-btn d-flex align-items-center justify-content-center gap-2">
                                        <!-- Google SVG -->
                                        <svg width="18" height="18" viewBox="0 0 48 48" aria-hidden="true">
                                            <path fill="#FFC107" d="M43.6 20.5H42V20H24v8h11.3C33.7 32.7 29.3 36 24 36c-6.6 0-12-5.4-12-12S17.4 12 24 12c3 0 5.7 1.1 7.8 3L37 9.8C33.9 7.1 29.2 5 24 5 13 5 4 14 4 25s9 20 20 20c11.5 0 19-8.1 19-19 0-1.2-.1-2.3-.4-3.5z" />
                                            <path fill="#FF3D00" d="M6.3 14.7l6.6 4.8C14.6 16.8 18.9 14 24 14c3 0 5.7 1.1 7.8 3l5.2-5.2C33.9 8.1 29.2 6 24 6c-7.5 0-13.9 4.3-17.1 10.7z" />
                                            <path fill="#4CAF50" d="M24 44c5.2 0 9.9-1.9 13.5-5.1l-6.2-5.1C29.3 36 26.8 37 24 37c-5.2 0-9.6-3.3-11.2-7.9L6.4 34.4C9.6 40 16.2 44 24 44z" />
                                            <path fill="#1976D2" d="M43.6 20.5H42V20H24v8h11.3c-1.1 3.3-4.7 6-8.3 6-5.2 0-9.6-3.3-11.2-7.9L6.4 34.4C9.6 40 16.2 44 24 44c8.5 0 16-5.7 18.4-13.6 0-1.2.2-2.3.2-3.5 0-2-.2-3.3-.6-6.4z" />
                                        </svg>
                                        Google
                                    </button>
                                </form>
                            }
                            else
                            {
                                <button type="button" class="btn btn-outline-danger w-100 social-btn d-flex align-items-center justify-content-center gap-2" disabled title="Configure Google keys in appsettings.json">
                                    <svg width="18" height="18" viewBox="0 0 48 48" aria-hidden="true"><circle cx="24" cy="24" r="20" fill="#e57373" /></svg>
                                    Google
                                </button>
                            }
                        </div>

                        <div class="col-12 col-md-4">
                            @if (hasGitHub)
                            {
                                <form asp-action="ExternalLogin" method="post">
                                    <input type="hidden" name="provider" value="GitHub" />
                                    <button type="submit" class="btn btn-outline-dark w-100 social-btn d-flex align-items-center justify-content-center gap-2">
                                        <!-- GitHub SVG -->
                                        <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true" fill="currentColor">
                                            <path d="M12 .5a11.5 11.5 0 0 0-3.64 22.42c.58.11.79-.25.79-.55v-2.1c-3.2.69-3.87-1.54-3.87-1.54-.53-1.36-1.29-1.72-1.29-1.72-1.05-.71.08-.7.08-.7 1.16.08 1.78 1.2 1.78 1.2 1.03 1.77 2.7 1.26 3.36.96.1-.76.4-1.26.72-1.55-2.55-.29-5.23-1.28-5.23-5.69 0-1.26.45-2.29 1.2-3.1-.12-.3-.52-1.5.11-3.11 0 0 .98-.31 3.2 1.19a11.1 11.1 0 0 1 5.82 0c2.22-1.5 3.2-1.19 3.2-1.19.63 1.61.23 2.81.11 3.11.75.81 1.2 1.84 1.2 3.1 0 4.42-2.69 5.39-5.25 5.68.41.36.77 1.07.77 2.17v3.22c0 .31.21.67.8.55A11.5 11.5 0 0 0 12 .5z" />
                                        </svg>
                                        GitHub
                                    </button>
                                </form>
                            }
                            else
                            {
                                <button type="button" class="btn btn-outline-dark w-100 social-btn d-flex align-items-center justify-content-center gap-2" disabled title="Configure GitHub keys in appsettings.json">
                                    <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true"><circle cx="12" cy="12" r="10" fill="#9e9e9e" /></svg>
                                    GitHub
                                </button>
                            }
                        </div>

                        <div class="col-12 col-md-4">
                            @if (hasFacebook)
                            {
                                <form asp-action="ExternalLogin" method="post">
                                    <input type="hidden" name="provider" value="Facebook" />
                                    <button type="submit" class="btn btn-outline-primary w-100 social-btn d-flex align-items-center justify-content-center gap-2">
                                        <!-- Facebook SVG -->
                                        <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true" fill="#1877F2">
                                            <path d="M22 12a10 10 0 1 0-11.6 9.9v-7h-2.2V12h2.2V9.8c0-2.2 1.3-3.5 3.4-3.5.98 0 2 .18 2 .18v2.2h-1.1c-1.1 0-1.4.69-1.4 1.4V12h2.4l-.38 2.9h-2.02v7A10 10 0 0 0 22 12z" />
                                        </svg>
                                        Facebook
                                    </button>
                                </form>
                            }
                            else
                            {
                                <button type="button" class="btn btn-outline-primary w-100 social-btn d-flex align-items-center justify-content-center gap-2" disabled title="Configure Facebook keys in appsettings.json">
                                    <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true"><circle cx="12" cy="12" r="10" fill="#bbdefb" /></svg>
                                    Facebook
                                </button>
                            }
                        </div>
                    </div>

                    <p class="text-center mt-4 mb-0">
                        @((isRtl ? "لا تملك حسابًا؟" : "Don’t have an account?"))
                        <a asp-action="SignUp">@((isRtl ? "أنشئ حسابًا" : "Create one"))</a>
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @await Html.PartialAsync("_ValidationScriptsPartial")
    <script>
        (function () {
          const forms = document.querySelectorAll('.needs-validation');
          Array.from(forms).forEach(f => {
            f.addEventListener('submit', e => {
              if (!f.checkValidity()) { e.preventDefault(); e.stopPropagation(); }
              f.classList.add('was-validated');
            }, false);
          });
        })();
    </script>
}
